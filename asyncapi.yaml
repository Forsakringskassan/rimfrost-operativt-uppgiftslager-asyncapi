asyncapi: 3.0.0
info:
  title: Operativt uppgiftslager API
  version: 1.1.0
  description: Operativt uppgiftslager för hantering av manuella uppgifter utförda av handläggare

channels:
  operativt.uppgiftslager.requests:
    messages:
      OperativtUppgiftslagerRequestMessage:
        $ref: '#/components/messages/OperativtUppgiftslagerRequestMessage'
  operativt.uppgiftslager.responses:
    messages:
      OperativtUppgiftslagerResponseMessage:
        $ref: '#/components/messages/OperativtUppgiftslagerResponseMessage'
  operativt.uppgiftslager.status.control:
    messages:
      OperativtUppgiftslagerStatusMessage:
        $ref: '#/components/messages/OperativtUppgiftslagerStatusMessage'
  operativt.uppgiftslager.status.notification:
    messages:
      OperativtUppgiftslagerStatusMessage:
        $ref: '#/components/messages/OperativtUppgiftslagerStatusMessage'

operations:
  onOperativtUppgiftslagerRequest:
    action: receive
    channel:
      $ref: '#/channels/operativt.uppgiftslager.requests'
    reply:
      address:
        description: Topic där response ska skickas
        location: "$message.header#/replyTo"
      channel:
        $ref: '#/channels/operativt.uppgiftslager.responses'
  operativtUppgiftslagerStatusControl:
    action: receive
    channel:
      $ref: '#/channels/operativt.uppgiftslager.status.control'
    summary: Hanterar statusuppdateringar
  operativtUppgiftslagerStatusNotification:
    action: send
    channel:
      $ref: '#/channels/operativt.uppgiftslager.status.notification'
    summary: Publicerar statusuppdateringar
  operativtUppgiftslagerStatusUpdate:
    action: receive
    channel:
      $ref: '#/channels/operativt.uppgiftslager.status.notification'
    summary: Konsumerar statusuppdateringar

components:
  messages:
    OperativtUppgiftslagerRequestMessage:
      payload:
        title: OperativtUppgiftslagerRequestMessagePayload
        allOf:
          - $ref: "kogito-cloudevent.yaml#/components/schemas/KogitoCloudEvent"
          - type: object
            title: OperativtUppgiftslagerRequestMessageData
            properties:
              data:
                $ref: "#/components/schemas/OperativtUppgiftslagerRequestMessageData"
    OperativtUppgiftslagerResponseMessage:
      headers:
        $ref: "#/components/schemas/OperativtUppgiftslagerResponseMessageHeaders"
      payload:
        title: OperativtUppgiftslagerResponseMessagePayload
        allOf:
          - $ref: "kogito-cloudevent.yaml#/components/schemas/KogitoCloudEvent"
          - type: object
            title: OperativtUppgiftslagerResponseMessageData
            properties:
              data:
                $ref: "#/components/schemas/OperativtUppgiftslagerResponseMessageData"
    OperativtUppgiftslagerStatusMessage:
      payload:
        title: OperativtUppgiftslagerStatusMessagePayload
        type: object
        required:
          - uppgift_id
          - process_id
          - status
        properties:
          uppgift_id:
            type: string
            description: Unikt ID som identifierar instansen av uppgifts-objektet
          process_id:
            type: string
            description: Unikt id som identifierar processinstansen
          personnummer:
            $ref: '#/components/schemas/Personnummer'
          resultat:
            type: string
            description: Utfall av uppgiften (endast relevant om status är Avslutad)
          status:
            title: status
            type: string
            description: Status för uppgiften
            enum:
              - Ny
              - Tilldelad
              - Avslutad

  schemas:
    
    OperativtUppgiftslagerRequestMessageData:
      type: object
      title: OperativtUppgiftslagerRequestMessageData
      required:
        - version
        - uppgiftspec_id
        - aktivitet
        - personnummer
        - frontend_gui_url
        - process_id
      properties:
        version:
          type: string
          description: Uppgiftens version
        uppgiftspec_id:
          type: string
          description: Unikt ID som identifierar uppgiftens specifikation
        aktivitet:
          type: string
          description: Arbetsbeskrivning för uppgiften
        personnummer:
          $ref: '#/components/schemas/Personnummer'
        frontend_gui_url:
          type: string
          description: URL för grafiska användargränssnittet som frontend behöver för att visa uppgiften korrekt
        process_id:
          type: string
          description: Unikt id som identifierar processinstansen

    OperativtUppgiftslagerResponseMessageHeaders:
      type: object
      properties:
        correlationId:
          type: string
          description: Unikt id som kopplar ihop request & response

    OperativtUppgiftslagerResponseMessageData:
      type: object
      title: OperativtUppgiftslagerResponseMessageData
      properties:
        uppgift_id:
          type: string
          description: Unikt ID som identifierar instansen av uppgifts-objektet
    Personnummer:
      type: string
      description: Svenskt personnummer (12 siffror med bindestreck)
      pattern: '^\d{8}-\d{4}$'
      example: "19990101-0123"

    Uppgift:
      type: object
      title: Uppgift
      required:
        - uppgift_id
        - version
        - uppgiftspec_id
        - status
        - aktivitet
        - personnummer
      properties:
        uppgift_id:
          type: string
          description: Unikt ID som identifierar instansen av uppgifts-objektet
        version:
          type: string
          description: Uppgiftens version
        uppgiftspec_id:
          type: string
          description: Unikt ID som identifierar uppgiftens specifikation
        skapad:
          type: string
          description: DateTime av när uppgiften skapades i ISO 8601 format
        utforar_id:
          type: string
          description: Unikt ID för utföraren
        planerad_till:
          type: string
          description: DateTime av tidpunkten som uppgiften är planerad att vara färdig i ISO 8601 format
        utford:
          type: string
          description: DateTime av tidpunkten som uppgiften blev färdig i ISO 8601 format
        status:
          type: string
          description: Uppgiftens status
        aktivitet:
          type: string
          description: Arbetsbeskrivning för uppgiften
        personnummer:
          $ref: '#/components/schemas/Personnummer'
        underlag:
          type: array
          items:
            $ref: '#/components/schemas/Underlag'

    Underlag:
      type: object
      required:
        - id
      properties:
        id:
          type: string
          description: Unikt id för Underlaget
      additionalProperties: true
      description: Underlag i valfritt format. Backend äger strukturen